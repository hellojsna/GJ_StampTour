function eById(e){return document.getElementById(e)}function eByCl(e){return document.getElementsByClassName(e)}function setCookie(e,t,n){var i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+";expires="+i.toUTCString()+";path=/; "}function getCookie(e){var t=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");return t?t[2]:null}function deleteCookie(e){document.cookie=encodeURIComponent(e)+"=;expires=Thu, 01 JAN 1999 00:00:10 GMT;"}var getJSON=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=function(){var e=n.status;t(200===e?null:e,n.response)},n.send()};function enableCookieUpdate(){setInterval((function(){let e=getCookie("LocalStamp");if(null!=e){let t=decodeURIComponent(e),n=JSON.parse(t);for(let e=0;e<n.length;e++){let t=eById(n[e]);null!=t&&t.classList.add("checked")}}}),1e3)}let CurrentFloor=1,guidePage=0,uA=window.navigator.userAgent.toLowerCase(),classroomList=eByCl("classroom"),notClassroomList=eByCl("notClassroom"),StampView=eById("StampView"),stampListView=eById("stampList"),GuideModalContainer=eById("GuideModalContainer"),ClassInfoModalContainer=eById("ClassInfoModalContainer"),ClassInfoModalTitle=eById("ClassInfoModalTitle"),CMSN=eById("CMStampName"),CMSD=eById("CMStampDesc"),CMST=eById("CMStampType"),CMSS=eById("CMStampStatus"),VideoPlayer=eById("GuideVideo"),GuideHint=eById("GuideHint"),GuideText=eById("GuideText"),NextGuideButton=eById("NextGuideButton"),StudentIdInput=eById("StudentIdInput"),StudentNameInput=eById("StudentNameInput");function getStampList(){getJSON("/api/stampList.json",(function(e,t){if(null!=e)alert("스탬프 목록 데이터를 불러오는 중 오류가 발생했습니다.");else if(null!==t){let e=t.stampList;for(let t=0;t<e.length;t++){let n=e[t];if(!n.stampId.startsWith("000000000-0000-0000-0000-")){let e=document.createElement("div");e.classList.add("stamp"),e.id=n.stampId,e.innerHTML=`<img src="/images/circle.svg"><img class="CheckMark" src="/images/check.svg"><span><h2>${n.stampName}</h2><p>${filterClassroomName(n.stampLocation)}</p></span>`,eById("stampList").appendChild(e)}}}}))}function enableMapZoom(e){"ontouchstart"in window||navigator.msMaxTouchPoints?zoom=panzoom(e,{bounds:!0,boundsPadding:0,maxZoom:2,minZoom:.3,zoomDoubleClickSpeed:1,onTouch:e=>{const t=e.target;let n=t.tagName,i=t.classList[0];if("hallway"!=i&&"notClassroom"!=i&&("g"===n||"rect"===n||"text"===n))return!1;e.preventDefault()}}):zoom=panzoom(e,{bounds:!0,boundsPadding:-.5,maxZoom:5,minZoom:.5,zoomDoubleClickSpeed:1,contain:"outside"})}function floorChange(e){let t=eById(`Floor${CurrentFloor}MapView`),n=eById(`Floor${e}MapView`);eById(`Floor${CurrentFloor}`).classList.remove("selected"),eById(`Floor${e}`).classList.add("selected"),t.classList.remove("active"),n.classList.add("active"),CurrentFloor=e}function setStampView(){eById("StampView");eById("StampView").addEventListener("click",(function(){eById("StampView").classList.toggle("open")})),eById("ShowGuideButton").addEventListener("click",(function(){eById("GuideModalContainer").style.display="flex",showNextGuide()}))}const userAgent=navigator.userAgent.toLowerCase(),isTablet=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(userAgent)||userAgent.includes("mac")&&navigator.maxTouchPoints>4&&!userAgent.includes("iphone");function showNextGuide(){switch(NextGuideButton.disabled=!0,VideoPlayer.play(),VideoPlayer.pause(),VideoPlayer.style.opacity=1,guidePage){case 0:VideoPlayer.currentTime=0,window.screen.width>1024||isTablet?GuideText.innerText=`${displayDeviceType}에서는 "코드 스캔" 버튼을 눌러서 참여할 수 있어요.`:GuideText.innerText=`${displayDeviceType}의 NFC 인식 위치는 ${displayNFCLocation}이에요.`,setTimeout((()=>{VideoPlayer.play(),setTimeout((()=>{VideoPlayer.pause(),NextGuideButton.disabled=!1}),840),guidePage+=1}),500);break;case 1:VideoPlayer.play(),window.screen.width>1024||isTablet?GuideText.innerText="스탬프의 아이콘을 카메라로 스캔해 주세요.":GuideText.innerText=`스탬프의 아이콘에 ${displayDeviceType}의 ${displayNFCLocation}을 대주세요.`,setTimeout((()=>{VideoPlayer.pause(),NextGuideButton.innerText="시작하기",NextGuideButton.disabled=!1,eById("ReplayButtonContainer").style.display="block"}),3800),guidePage+=1;break;case 2:NextGuideButton.disabled=!0,NextGuideButton.innerText="시작하기",GuideText.style.display="none",VideoPlayer.style.display="none",eById("ReplayButtonContainer").style.display="none",eById("PrivacyPolicyCheckboxContainer").style.display="flex",eById("GuideTitle").innerText="시작 전 본인의 정보를 알려주세요",GuideHint.innerText="타인의 정보를 도용할 경우 불이익이 있을 수 있습니다.",GuideHint.style.color="var(--red)",StudentIdInput.addEventListener("input",(()=>{StudentIdInput.value=StudentIdInput.value.replace(/[^0-9]/g,"");let e=StudentIdInput.value.length;e>=6?StudentIdInput.value=StudentIdInput.value.slice(0,5):e>=5&&StudentNameInput.focus()})),StudentNameInput.addEventListener("input",(()=>{let e=StudentNameInput.value.length;NextGuideButton.disabled=!(e>=2)})),StudentIdInput.style.display="block",StudentNameInput.style.display="block",setTimeout((()=>{StudentIdInput.classList.add("show"),StudentNameInput.classList.add("show")}),100),guidePage+=1;break;case 3:var e=new XMLHttpRequest;e.open("POST","/login",!0),e.setRequestHeader("Content-Type","application/json"),e.responseType="json",e.onload=function(){200===e.status?(alert(`${e.response.user_name}(${e.response.user_id})님, 환영합니다.)`),setCookie("user_id",e.response.user_id,7),setCookie("user_name",StudentIdInput.value+StudentNameInput.value,7),setCookie("ShowGuide","true",1),guidePage=0,GuideModalContainer.style.display="none"):(alert("서버와 통신을 실패했습니다. 다시 시도해 주세요."),NextGuideButton.disabled=!1)},e.send(`{ "user_name": "${StudentIdInput.value}${StudentNameInput.value}" }`);break;default:break}}function loadGuideVideo(e){let t=window.matchMedia("(prefers-color-scheme: dark)").matches?"_Dark":"",n=document.createElement("source");n.src=`/videos/Guide_NFC_${e}${t}.webm`,n.type="video/webm";let i=document.createElement("source");i.src=`/videos/Guide_NFC_${e}${t}.webm`,i.type="video/mp4",VideoPlayer.appendChild(n),VideoPlayer.appendChild(i)}function checkDirection(){touchendY<touchstartY?StampView.classList.contains("open")||StampView.classList.toggle("open"):touchendY>touchstartY&&StampView.classList.contains("open")&&StampView.classList.toggle("open")}for(let e=1;e<=4;e++)enableMapZoom(eById(`Floor${e}MapView`));for(let e=1;e<=4;e++)eById(`Floor${e}`).addEventListener("click",(()=>floorChange(e)));function filterClassroomName(e){return e.startsWith("교실")?`${e.slice(0,3)}학년 ${e.slice(3)}반`.replace("교실","").replace(" 0"," "):e}window.location.hash.startsWith("#Floor")&&floorChange(window.location.hash.replace("#Floor","")),getJSON("/api/stampList.json",(function(e,t){if(null!=e)alert("스탬프 목록을 불러오는 중 오류가 발생했습니다.");else if(null!==t){let e=t.stampList;for(let t=0;t<e.length;t++){let n=e[t],i=n.stampLocation.split(",");if(i.length>1)for(let e=0;e<i.length;e++)eById(i[e]).addEventListener("click",(()=>{ClassInfoModalContainer.style.display="flex",ClassInfoModalTitle.innerText=`${i[e]}(${i[e-1]?i[e-1]:i[e+1]})`,CMSN.innerText=n.stampName,CMSD.innerText=n.stampDesc}));else eById(n.stampLocation).addEventListener("click",(()=>{switch(ClassInfoModalContainer.style.display="flex",ClassInfoModalTitle.innerText=filterClassroomName(n.stampLocation),CMSN.innerText=n.stampName,CMST.removeAttribute("class"),CMST.innerText=n.stampDesc.slice(1,n.stampDesc.indexOf("]")),CMST.innerText){case"공연":CMST.classList.add("gongyeon");break;case"전시":CMST.classList.add("jeonsi");break;case"전시 및 체험":CMST.classList.add("jeonsicheheom");break;case"체험":CMST.classList.add("cheheom");break;default:break}if(CMSD.innerText=n.stampDesc.slice(n.stampDesc.indexOf("]")+2),stampCheck=getCookie("LocalStamp"),n.stampId.startsWith("000000000-0000-0000-0000-")||null==stampCheck)CMSS.innerText="-",CMSS.classList.remove("checked");else{JSON.parse(decodeURIComponent(stampCheck)).includes(n.stampId)?(CMSS.innerText="방문한 부스",CMSS.classList.add("checked")):(CMSS.innerText="방문하지 않은 부스",CMSS.classList.remove("checked"))}}))}}}));for(let e=0;e<notClassroomList.length;e++)notClassroomList[e].addEventListener("click",(()=>{}));StampView.addEventListener("touchstart",(e=>{const t=e.target;let n=t.tagName,i=t.classList[0];touchstartY=stampListView.scrollTop<=0||t!=stampListView&&"stamp"!=i&&"span"!=n&&"img"!=n&&"h2"!=n&&"p"!=n?e.changedTouches[0].screenY:0}));let touchstartY=0,touchendY=0;StampView.addEventListener("touchend",(e=>{const t=e.target;let n=t.tagName,i=t.classList[0];(stampListView.scrollTop<=0||t!=stampListView&&"stamp"!=i&&"span"!=n&&"img"!=n&&"h2"!=n&&"p"!=n)&&(touchendY=e.changedTouches[0].screenY,checkDirection())})),eById("ClassInfoModalCloseButton").addEventListener("click",(()=>{ClassInfoModalContainer.style.display="none"})),NextGuideButton.addEventListener("click",showNextGuide);let displayDeviceType="접속하신 기기",displayNFCLocation="후면 중앙";uA.includes("iphone")?(displayDeviceType="iPhone",displayNFCLocation="상단",loadGuideVideo("iPhone"),document.ondblclick=function(e){e.preventDefault()}):window.screen.width>1024||isTablet?(loadGuideVideo("NoNFC"),displayDeviceType="태블릿 또는 NFC 기능이 없는 휴대전화"):uA.includes("sm-f700")||uA.includes("sm-f707")||uA.includes("sm-f711")||uA.includes("sm-f721")||uA.includes("sm-f731")||uA.includes("sm-f741")?(displayDeviceType="갤럭시 Z 플립",displayNFCLocation="후면 하단",loadGuideVideo("Bottom")):loadGuideVideo("Center"),GuideHint.innerText=`${displayDeviceType}에서의 참여 방법을 알려 드릴게요.`,eById("ReplayGuideButton").addEventListener("click",(()=>{guidePage=0,showNextGuide()})),window.onload=function(){VideoPlayer.pause(),setStampView(),getStampList(),enableCookieUpdate(),null==getCookie("ShowGuide")&&(GuideModalContainer.style.display="flex",showNextGuide())};